<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Code Kata Challenges</title>
    <!-- Load CodeMirror CSS and Theme -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <!-- Custom CSS -->
    <style>
        @font-face {
            font-family: reithsans;
            src: url(assets/reithsans.woff);
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'reithsans';
            width: 100vw;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #932c3f, #8e2848, #882550, #7f2559, #752760, #6f2866, #672b6c, #5e2d72, #572f7a, #4d3182, #3f358b, #293893, #132125);
            background-size: 200% 200%;
            animation: gradient 15s ease infinite;
        }

        .challenge-header {
            background-color: white;
            padding: 20px 5vw 20px 5vw;
        }
        .container {
            height: 100%; /* Adjust this value as needed */
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #fff;
            overflow-y: auto;
        }
        h1 {
            color: #333;
            text-align: left;
        }
        #editor {
            height: 300px;
        }
        .CodeMirror {
            flex-grow: 1;
            padding-top: 10px;
        }
        .header-bar {
            background-color: lightgray;
            padding: 5px 10px;
        }
        .styled-select, button {
            display: block;
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
        }
        .styled-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg%20xmlns="http://www.w3.org/2000/svg"%20width="24"%20height="24"%20viewBox="0%200%2024%2024"><path%20fill="%23ffffff"%20d="M7%2010l5%205%205-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px 16px;
        }
        button:hover, .styled-select:hover {
            background: #0056b3;
        }
        #output {
            background: #282a36;
            color: #f8f8f2;
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }
        .test-pass {
            color: green;
        }
        .test-fail {
            color: red;
        }
        /* Additional styling for the solution button */
        #solution-button {
            background-color: #28a745;
        }
        #solution-button:hover {
            background-color: #218838;
        }
        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
        }
        .left-panel {
            width: 60%;
        }
        .right-panel {
            width: 40%;
        }
        #console-output {
            height: 50%;
            overflow-y: auto;
            background-color: black;
            color: white;
            padding: 20px;
            margin-bottom: 15px;
            font-family: monospace;
            word-wrap: break-word;
            line-height: 25px;
        }
        /* Styling for the ticket box */
        #challenge-description {
            margin: 20px 0;
            background-color: #f9f9f9;
            padding: 15px;
            border-left: 6px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #challenge-description p {
            color: #333;
        }
        #challenge-description p:first-child {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div style="width: 100%; height: 100vh; padding: 40px;">

        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">

            <div class="bbc_logo" style="width: 30%;">
                <svg xmlns="http://www.w3.org/2000/svg" id="BBC_Logo" viewBox="0 0 1024 384"><style>.st0{fill:#FFFFFF;}</style><defs><path id="BBC_Logo_White_RGB_Path" d="M0 0h211.122v60.482H0z"></path></defs><path class="st0" d="M64,64v256h256V64H64z M242.5,244.7c-4.4,6.2-10.6,10.9-18.7,14.3c-8.1,3.4-17.8,5-29.2,5h-57.4V120h54
                    c15.9,0,28.3,3.2,37,9.6c8.7,6.4,13.1,15.5,13.1,27.5c0,6.8-1.6,12.8-4.7,17.8c-3.1,5-7.8,9-13.9,12c8.5,2.8,15,7.3,19.5,13.4
                    c4.5,6.1,6.8,13.5,6.8,22.3C249.1,231.1,246.9,238.5,242.5,244.7z M205.9,174.3c4-3.3,6-7.9,6-13.8c0-11.4-7.8-17.1-23.3-17.1
                    h-22.1v35.8h22.1C196.2,179.2,201.9,177.6,205.9,174.3z M192.3,201.8h-25.8v38.9h25.5c8.7,0,15.5-1.6,20.2-4.9c4.7-3.3,7-8,7-14.2
                    C219.1,208.3,210.2,201.8,192.3,201.8z"></path><path class="st0" d="M384,64v256h256V64H384z M562.5,244.7c-4.4,6.2-10.6,10.9-18.7,14.3c-8.1,3.4-17.8,5-29.2,5h-57.4V120h54
                    c15.9,0,28.3,3.2,37,9.6c8.7,6.4,13.1,15.5,13.1,27.5c0,6.8-1.6,12.8-4.7,17.8c-3.1,5-7.8,9-13.9,12c8.5,2.8,15,7.3,19.5,13.4
                    c4.5,6.1,6.8,13.5,6.8,22.3C569.1,231.1,566.9,238.5,562.5,244.7z M525.9,174.3c4-3.3,6-7.9,6-13.8c0-11.4-7.8-17.1-23.3-17.1
                    h-22.1v35.8h22.1C516.2,179.2,521.9,177.6,525.9,174.3z M512.3,201.8h-25.8v38.9h25.5c8.7,0,15.5-1.6,20.2-4.9c4.7-3.3,7-8,7-14.2
                    C539.1,208.3,530.2,201.8,512.3,201.8z"></path><path class="st0" d="M704,320h256V64H704V320z M887.9,254.9c-6,3.3-12.9,5.9-20.7,7.8c-7.9,1.9-16.1,2.9-24.8,2.9
                    c-11.5,0-21.9-1.7-31.1-5c-9.2-3.4-17-8.2-23.4-14.5c-6.4-6.3-11.2-14-14.6-23.2c-3.4-9.1-5.1-19.4-5.1-30.9
                    c0-11.2,1.8-21.3,5.3-30.3c3.5-9,8.6-16.7,15.2-23.2c6.6-6.4,14.6-11.4,23.9-14.8c9.3-3.4,19.7-5.1,31.2-5.1c8,0,15.5,0.8,22.7,2.5
                    c7.1,1.6,13.7,4,19.8,7.2v28c-5.6-3.7-11.6-6.5-18.1-8.4c-6.5-1.9-13.3-2.9-20.5-2.9c-9.9,0-18.3,1.8-25.3,5.5
                    c-7,3.7-12.3,9-16.1,16c-3.7,7-5.6,15.5-5.6,25.5c0,10,1.8,18.5,5.4,25.6c3.6,7,8.8,12.4,15.6,16.1c6.8,3.7,15.1,5.5,24.9,5.5
                    c14.9,0,28.7-3.9,41.3-11.6V254.9z"></path>
                </svg>
            </div>

            <h1 style="color: white; font-size: 5em; font-weight: light;">Coding Challenge</h1>

            <h1 style="color: white; font-size: 2em;">Do you have what it takes? (probably)</h1>

        </div>

    </div>

    <div style="width: 100%; height: 100vh; padding: 40px;">
        <div class="container">
            <div class="left-panel">
                <!-- Selectors -->
                <div style="display: flex; gap: 15px;">
                    <select id="language-selector" class="styled-select" onchange="loadLanguage()">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                    </select>
                    <select id="challenge-selector" class="styled-select" onchange="loadChallengeSelector()">
                        <option value="reverseString">Reverse String (Easy)</option>
                        <option value="countVowels">Count Vowels (Easy)</option>
                        <option value="isPalindrome">Check Palindrome (Medium)</option>
                        <option value="isAnagram">Check Anagrams (Hard)</option>
                    </select>
                </div>
                <!-- Challenge description moved here -->
                <div id="challenge-description">
                    <p>Implement a function `add(a, b)` that returns the sum of two numbers.</p>
                    <p><strong>Example:</strong> `add(2, 3)` should return `5`.</p>
                </div>
                <!-- Code Editor -->
                <span class="header-bar">Code Editor</span>
                <textarea id="editor"></textarea>
                <!-- Buttons -->
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button onclick="runTests()">Run code and tests</button>
                    <button id="solution-button" onclick="showSolution()">Show Solution</button>
                </div>
            </div>
    
            <div class="right-panel">
                <span class="header-bar">Console Output</span>
                <!-- Console Output Section -->
                <div id="console-output"></div>
    
                <span class="header-bar">Test Results</span>
                <!-- Test Results Output -->
                <div id="output"></div>
            </div>
        </div>
    </div>

    <!-- Load CodeMirror Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <!-- JavaScript and Python modes for CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js">
    </script>
    <!-- Load Skulpt for Python execution -->
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

    <script>
        let editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            lineNumbers: true,
            mode: "javascript",
            theme: "dracula",
            indentUnit: 2,
            indentWithTabs: true,
        });

        let currentLanguage = 'javascript';
        let currentChallenge = 'reverseString';

        // Store challenges and test cases
        const challenges = {
            javascript: {
                reverseString: {
                    description: "Ticket #12345: The `reverseString(str)` function is supposed to reverse a given string, but it's not working correctly. Please fix the code so that it passes all the tests.",
                    example: "`reverseString('hello')` should return `'olleh'`.",
                    difficulty: "Easy",
                    functionName: "reverseString",
                    starterCode: `function reverseString(str) {
    // Buggy code
    return str;
}`,
                    solutionCode: `function reverseString(str) {
    let reversed = '';
    for (let i = str.length - 1; i >= 0; i--) {
        reversed += str[i];
    }
    return reversed;
}`,
                    tests: [
                        { input: 'hello', expected: 'olleh', description: 'should return "olleh" for reverseString("hello")' },
                        { input: 'world', expected: 'dlrow', description: 'should return "dlrow" for reverseString("world")' },
                        { input: '', expected: '', description: 'should return "" for reverseString("")' },
                        { input: 'a', expected: 'a', description: 'should return "a" for reverseString("a")' },
                        { input: 'racecar', expected: 'racecar', description: 'should return "racecar" for reverseString("racecar")' },
                    ]
                },
                countVowels: {
                    description: "Ticket #12346: The `countVowels(str)` function is supposed to count the number of vowels in a given string. Please fix the code so that it passes all the tests.",
                    example: "`countVowels('hello')` should return `2`.",
                    difficulty: "Easy",
                    functionName: "countVowels",
                    starterCode: `function countVowels(str) {
    // Buggy code
    return 0;
}`,
                    solutionCode: `function countVowels(str) {
    let count = 0;
    const vowels = 'aeiouAEIOU';
    for (let i = 0; i < str.length; i++) {
        let char = str[i];
        if (vowels.indexOf(char) !== -1) {
            count++;
        }
    }
    return count;
}`,
                    tests: [
                        { input: 'hello', expected: 2, description: 'should return 2 for countVowels("hello")' },
                        { input: 'world', expected: 1, description: 'should return 1 for countVowels("world")' },
                        { input: '', expected: 0, description: 'should return 0 for countVowels("")' },
                        { input: 'AEIOU', expected: 5, description: 'should return 5 for countVowels("AEIOU")' },
                        { input: 'bcdfghjklmnpqrstvwxyz', expected: 0, description: 'should return 0 for countVowels("bcdfghjklmnpqrstvwxyz")' },
                    ]
                },
                isPalindrome: {
                    description: "Ticket #12347: The `isPalindrome(str)` function is supposed to check if a given string is a palindrome, but it's not working correctly. Please fix the code so that it passes all the tests.",
                    example: "`isPalindrome('racecar')` should return `true`.",
                    difficulty: "Medium",
                    functionName: "isPalindrome",
                    starterCode: `function isPalindrome(str) {
    // Buggy code
    return false;
}`,
                    solutionCode: `function isPalindrome(str) {
    let left = 0;
    let right = str.length - 1;
    while (left < right) {
        if (str[left] !== str[right]) {
            return false;
        }
        left++;
        right--;
    }
    return true;
}`,
                    tests: [
                        { input: 'racecar', expected: true, description: 'should return true for isPalindrome("racecar")' },
                        { input: 'hello', expected: false, description: 'should return false for isPalindrome("hello")' },
                        { input: 'level', expected: true, description: 'should return true for isPalindrome("level")' },
                        { input: '', expected: true, description: 'should return true for isPalindrome("")' },
                        { input: 'A', expected: true, description: 'should return true for isPalindrome("A")' },
                    ]
                },
                isAnagram: {
                    description: "Ticket #12348: The `isAnagram(str1, str2)` function is supposed to check if two strings are anagrams of each other. Please fix the code so that it passes all the tests.",
                    example: "`isAnagram('listen', 'silent')` should return `true`.",
                    difficulty: "Hard",
                    functionName: "isAnagram",
                    starterCode: `function isAnagram(str1, str2) {
    // Buggy code
    return false;
}`,
                    solutionCode: `function isAnagram(str1, str2) {
    function buildCharMap(str) {
        const charMap = {};
        for (let char of str.replace(/\\s/g, '').toLowerCase()) {
            charMap[char] = charMap[char] + 1 || 1;
        }
        return charMap;
    }
    const charMap1 = buildCharMap(str1);
    const charMap2 = buildCharMap(str2);

    if (Object.keys(charMap1).length !== Object.keys(charMap2).length) {
        return false;
    }
    for (let char in charMap1) {
        if (charMap1[char] !== charMap2[char]) {
            return false;
        }
    }
    return true;
}`,
                    tests: [
                        { input: ['listen', 'silent'], expected: true, description: 'should return true for isAnagram("listen", "silent")' },
                        { input: ['hello', 'world'], expected: false, description: 'should return false for isAnagram("hello", "world")' },
                        { input: ['anagram', 'nagaram'], expected: true, description: 'should return true for isAnagram("anagram", "nagaram")' },
                        { input: ['Dormitory', 'Dirty room'], expected: true, description: 'should return true for isAnagram("Dormitory", "Dirty room")' },
                        { input: ['School master', 'The classroom'], expected: true, description: 'should return true for isAnagram("School master", "The classroom")' },
                    ]
                }
            },
            python: {
                reverseString: {
                    description: "Ticket #12345: The `reverse_string(s)` function is supposed to reverse a given string, but it's not working correctly. Please fix the code so that it passes all the tests.",
                    example: "`reverse_string('hello')` should return `'olleh'`.",
                    difficulty: "Easy",
                    functionName: "reverse_string",
                    starterCode: `def reverse_string(s):
    # Buggy code
    return s`,
                    solutionCode: `def reverse_string(s):
    reversed_s = ''
    for i in range(len(s)-1, -1, -1):
        reversed_s += s[i]
    return reversed_s`,
                    tests: [
                        { input: 'hello', expected: 'olleh', description: 'should return "olleh" for reverse_string("hello")' },
                        { input: 'world', expected: 'dlrow', description: 'should return "dlrow" for reverse_string("world")' },
                        { input: '', expected: '', description: 'should return "" for reverse_string("")' },
                        { input: 'a', expected: 'a', description: 'should return "a" for reverse_string("a")' },
                        { input: 'racecar', expected: 'racecar', description: 'should return "racecar" for reverse_string("racecar")' },
                    ]
                },
                countVowels: {
                    description: "Ticket #12346: The `count_vowels(s)` function is supposed to count the number of vowels in a given string. Please fix the code so that it passes all the tests.",
                    example: "`count_vowels('hello')` should return `2`.",
                    difficulty: "Easy",
                    functionName: "count_vowels",
                    starterCode: `def count_vowels(s):
    # Buggy code
    return 0`,
                    solutionCode: `def count_vowels(s):
    count = 0
    vowels = 'aeiouAEIOU'
    for char in s:
        if char in vowels:
            count += 1
    return count`,
                    tests: [
                        { input: 'hello', expected: 2, description: 'should return 2 for count_vowels("hello")' },
                        { input: 'world', expected: 1, description: 'should return 1 for count_vowels("world")' },
                        { input: '', expected: 0, description: 'should return 0 for count_vowels("")' },
                        { input: 'AEIOU', expected: 5, description: 'should return 5 for count_vowels("AEIOU")' },
                        { input: 'bcdfghjklmnpqrstvwxyz', expected: 0, description: 'should return 0 for count_vowels("bcdfghjklmnpqrstvwxyz")' },
                    ]
                },
                isPalindrome: {
                    description: "Ticket #12347: The `is_palindrome(s)` function is supposed to check if a given string is a palindrome, but it's not working correctly. Please fix the code so that it passes all the tests.",
                    example: "`is_palindrome('racecar')` should return `True`.",
                    difficulty: "Medium",
                    functionName: "is_palindrome",
                    starterCode: `def is_palindrome(s):
    # Buggy code
    return False`,
                    solutionCode: `def is_palindrome(s):
    left = 0
    right = len(s) - 1
    while left < right:
        if s[left] != s[right]:
            return False
        left += 1
        right -= 1
    return True`,
                    tests: [
                        { input: 'racecar', expected: true, description: 'should return True for is_palindrome("racecar")' },
                        { input: 'hello', expected: false, description: 'should return False for is_palindrome("hello")' },
                        { input: 'level', expected: true, description: 'should return True for is_palindrome("level")' },
                        { input: '', expected: true, description: 'should return True for is_palindrome("")' },
                        { input: 'A', expected: true, description: 'should return True for is_palindrome("A")' },
                    ]
                },
                isAnagram: {
                    description: "Ticket #12348: The `is_anagram(str1, str2)` function is supposed to check if two strings are anagrams of each other. Please fix the code so that it passes all the tests.",
                    example: "`is_anagram('listen', 'silent')` should return `True`.",
                    difficulty: "Hard",
                    functionName: "is_anagram",
                    starterCode: `def is_anagram(str1, str2):
    # Buggy code
    return False`,
                    solutionCode: `def is_anagram(str1, str2):
    def build_char_map(s):
        char_map = {}
        for char in s.replace(' ', '').lower():
            char_map[char] = char_map.get(char, 0) + 1
        return char_map
    char_map1 = build_char_map(str1)
    char_map2 = build_char_map(str2)
    return char_map1 == char_map2`,
                    tests: [
                        { input: ['listen', 'silent'], expected: true, description: 'should return True for is_anagram("listen", "silent")' },
                        { input: ['hello', 'world'], expected: false, description: 'should return False for is_anagram("hello", "world")' },
                        { input: ['anagram', 'nagaram'], expected: true, description: 'should return True for is_anagram("anagram", "nagaram")' },
                        { input: ['Dormitory', 'Dirty room'], expected: true, description: 'should return True for is_anagram("Dormitory", "Dirty room")' },
                        { input: ['School master', 'The classroom'], expected: true, description: 'should return True for is_anagram("School master", "The classroom")' },
                    ]
                }
            }
        };

        function loadChallenge() {
            const challenge = challenges[currentLanguage][currentChallenge];
            document.getElementById('challenge-description').innerHTML = `<p>${challenge.description}</p><p><strong>Example:</strong> ${challenge.example}</p>`;
            editor.setValue(challenge.starterCode.trim());
            editor.setOption('mode', currentLanguage === 'python' ? 'python' : 'javascript');

            // Configure indentation based on language
            if (currentLanguage === 'python') {
                editor.setOption('indentUnit', 4);
                editor.setOption('indentWithTabs', false);
                editor.setOption('extraKeys', {
                    Tab: function(cm) {
                        if (cm.somethingSelected()) {
                            cm.indentSelection("add");
                        } else {
                            cm.replaceSelection(" ".repeat(cm.getOption("indentUnit")), "end", "+input");
                        }
                    }
                });
            } else {
                editor.setOption('indentUnit', 2);
                editor.setOption('indentWithTabs', true);
                editor.setOption('extraKeys', {
                    Tab: 'default'
                });
            }
        }

        function loadLanguage() {
            currentLanguage = document.getElementById('language-selector').value;
            loadChallenge();
        }

        function loadChallengeSelector() {
            currentChallenge = document.getElementById('challenge-selector').value;
            loadChallenge();
        }

        function runTests() {
            const code = editor.getValue();
            const output = document.getElementById("output");
            const consoleOutput = document.getElementById("console-output");
            output.innerHTML = "";
            consoleOutput.innerHTML = "";

            const challenge = challenges[currentLanguage][currentChallenge];
            const tests = challenge.tests;
            const funcName = challenge.functionName;

            if (currentLanguage === 'javascript') {
                // Save original console methods
                const originalConsoleLog = console.log;
                const originalConsoleError = console.error;

                // Create a custom console object
                const userConsoleOutput = [];
                console.log = (...args) => {
                    userConsoleOutput.push(args.join(' '));
                };
                console.error = (...args) => {
                    userConsoleOutput.push(args.join(' '));
                };

                // Append code to attach the function to window
                const codeWithExport = code + `
window['${funcName}'] = ${funcName};
`;

                // Function to run user's code and capture output
                const runUserCode = () => {
                    try {
                        // Execute user's code in the global scope
                        eval(codeWithExport);
                    } catch (e) {
                        consoleOutput.innerHTML = `<div style="color:red;">${e.message}</div>`;
                        throw e; // Rethrow to prevent tests from running
                    }
                };

                // Run user's code and capture console output
                try {
                    runUserCode();
                    // Display user's console output
                    consoleOutput.innerHTML = userConsoleOutput.map(line => `<div>${line}</div>`).join("");
                } catch (e) {
                    // Error already displayed in console output
                    // Restore original console methods
                    console.log = originalConsoleLog;
                    console.error = originalConsoleError;
                    return;
                }

                // Run tests
                try {
                    const userFunc = window[funcName];
                    if (typeof userFunc !== 'function') {
                        throw new Error(`Function '${funcName}' is not defined.`);
                    }

                    tests.forEach(test => {
                        let result;
                        try {
                            // Capture console output during tests
                            userConsoleOutput.length = 0;
                            if (Array.isArray(test.input)) {
                                result = userFunc(...test.input);
                            } else {
                                result = userFunc(test.input);
                            }
                            const passed = JSON.stringify(result) === JSON.stringify(test.expected);

                            const testResult = document.createElement("div");
                            testResult.style.padding = "5px";
                            testResult.style.marginBottom = "10px";

                            if (passed) {
                                testResult.style.backgroundColor = "#d4edda";
                                testResult.style.color = "#155724";
                                testResult.textContent = `✔️ ${test.description}`;
                            } else {
                                testResult.style.backgroundColor = "#f8d7da";
                                testResult.style.color = "#721c24";
                                testResult.textContent = `❌ ${test.description} (Expected: ${JSON.stringify(test.expected)}, Got: ${JSON.stringify(result)})`;
                            }
                            output.appendChild(testResult);

                            // Append console output for each test
                            if (userConsoleOutput.length > 0) {
                                consoleOutput.innerHTML += userConsoleOutput.map(line => `<div>${line}</div>`).join("");
                            }
                        } catch (err) {
                            const errorDiv = document.createElement("div");
                            errorDiv.style.backgroundColor = "#f8d7da";
                            errorDiv.style.color = "#721c24";
                            errorDiv.style.padding = "10px";
                            errorDiv.textContent = `Error in test "${test.description}": ${err.message}`;
                            output.appendChild(errorDiv);
                        }
                    });

                } catch (e) {
                    output.innerHTML = `<div style="color:red;">${e.message}</div>`;
                } finally {
                    // Restore original console methods
                    console.log = originalConsoleLog;
                    console.error = originalConsoleError;
                }
            } else if (currentLanguage === 'python') {
                const userConsoleOutput = [];
                Sk.configure({
                    output: function (text) {
                        userConsoleOutput.push(text);
                    },
                    read: function (x) {
                        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                            throw "File not found: '" + x + "'";
                        return Sk.builtinFiles["files"][x];
                    },
                    __future__: Sk.python3,
                    syspath: [],
                });

                (async function () {
                    try {
                        // Run user's code
                        const module = await Sk.misceval.asyncToPromise(function () {
                            return Sk.importMainWithBody("<stdin>", false, code, true);
                        });

                        const funcName = challenge.functionName;

                        // Get user's function
                        let pyFunc = module.$d[funcName];

                        if (!pyFunc || typeof pyFunc.tp$call !== 'function') {
                            throw new Error(`Function '${funcName}' is not defined.`);
                        }

                        // Display user's console output
                        if (userConsoleOutput.length > 0) {
                            consoleOutput.innerHTML = userConsoleOutput.map(line => `<div>${line}</div>`).join("");
                        }

                        // Run tests
                        for (const test of tests) {
                            try {
                                // Capture console output during tests
                                userConsoleOutput.length = 0;
                                const input = Array.isArray(test.input) ? test.input.map(Sk.ffi.remapToPy) : [Sk.ffi.remapToPy(test.input)];
                                const result = Sk.ffi.remapToJs(
                                    await Sk.misceval.callsimAsync(null, pyFunc, ...input)
                                );

                                const passed = JSON.stringify(result) === JSON.stringify(test.expected);

                                const testResult = document.createElement("div");
                                testResult.style.padding = "5px";
                                testResult.style.marginBottom = "10px";

                                if (passed) {
                                    testResult.style.backgroundColor = "#d4edda";
                                    testResult.style.color = "#155724";
                                    testResult.textContent = `✔️ ${test.description}`;
                                } else {
                                    testResult.style.backgroundColor = "#f8d7da";
                                    testResult.style.color = "#721c24";
                                    testResult.textContent = `❌ ${test.description} (Expected: ${JSON.stringify(test.expected)}, Got: ${JSON.stringify(result)})`;
                                }
                                output.appendChild(testResult);

                                // Append console output for each test
                                if (userConsoleOutput.length > 0) {
                                    consoleOutput.innerHTML += userConsoleOutput.map(line => `<div>${line}</div>`).join("");
                                }
                            } catch (err) {
                                const errorDiv = document.createElement("div");
                                errorDiv.style.backgroundColor = "#f8d7da";
                                errorDiv.style.color = "#721c24";
                                errorDiv.style.padding = "10px";
                                errorDiv.textContent = `Error in test "${test.description}": ${err.toString()}`;
                                output.appendChild(errorDiv);
                            }
                        }

                    } catch (err) {
                        consoleOutput.innerHTML = `<div style="color:red;">${err.toString()}</div>`;
                    }
                })();
            }
        }

        function showSolution() {
            const challenge = challenges[currentLanguage][currentChallenge];
            editor.setValue(challenge.solutionCode);
            editor.setOption('mode', currentLanguage === 'python' ? 'python' : 'javascript');

            // Reconfigure indentation settings when showing solution
            if (currentLanguage === 'python') {
                editor.setOption('indentUnit', 4);
                editor.setOption('indentWithTabs', false);
                editor.setOption('extraKeys', {
                    Tab: function(cm) {
                        if (cm.somethingSelected()) {
                            cm.indentSelection("add");
                        } else {
                            cm.replaceSelection(" ".repeat(cm.getOption("indentUnit")), "end", "+input");
                        }
                    }
                });
            } else {
                editor.setOption('indentUnit', 2);
                editor.setOption('indentWithTabs', true);
                editor.setOption('extraKeys', {
                    Tab: 'default'
                });
            }
        }

        // Initialize the page
        loadChallenge();

    </script>
</body>
</html>
